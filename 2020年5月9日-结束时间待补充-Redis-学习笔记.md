## Redis String类型命令

#### 1. SET 命令 （SET key value [EX seconds] [PX milliseconds] [NX|XX]）

- `EX second` ：设置键的过期时间为 `second` 秒。 `SET key value EX second` 效果等同于 `SETEX key second value` 。

- `PX millisecond` ：设置键的过期时间为 `millisecond` 毫秒。 `SET key value PX millisecond` 效果等同于 `PSETEX key millisecond value` 。

- `NX` ：只在键不存在时，才对键进行设置操作。 `SET key value NX` 效果等同于 `SETNX key value` 。
- `XX` ：只在键已经存在时，才对键进行设置操作。

##### 1.1 set a 1  

如果之前存在过key，则会直接覆盖 value

> 127.0.0.1:6379> set a 1
> OK
> 127.0.0.1:6379> get a
> "1"
> 127.0.0.1:6379> set a 2
> OK
> 127.0.0.1:6379> get a
> "2"

##### 1.2 set a 1 ex 10 （ex 0会报错）

添加一个只存活10秒的 key：a

> 127.0.0.1:6379> set a 1 ex 10
> OK
> 127.0.0.1:6379> get a
> "1"
>
> 10秒后
>
> 127.0.0.1:6379> get a
> (nil)
>
> 127.0.0.1:6379> set a 1 ex 0
> (error) ERR invalid expire time in set

##### 1.3 set a 1 px 10000 （px 0会报错）

添加一个只存活10000毫秒（10秒）的 key：a

> 127.0.0.1:6379> set a 1 px 10000
> OK
> 127.0.0.1:6379> get a
> "1"
>
> 10秒后
>
> 127.0.0.1:6379> get a
> (nil)
>
> 127.0.0.1:6379> set a 1 px 0
> (error) ERR invalid expire time in set

##### 1.4 set a 1 nx（和xx相反）

当key：a 不存在时，才会添加，如果有则会忽略

> 127.0.0.1:6379> keys *
> (empty list or set)
> 127.0.0.1:6379> set a 1 nx
> OK
> 127.0.0.1:6379> get a
> "1"
> 127.0.0.1:6379> set a 2 nx
> (nil)
> 127.0.0.1:6379> get a
> "1"

##### 1.5 set a 1 xx （和nx相反）

当key：a 存在时，才会修改，否则则忽略

> 127.0.0.1:6379> keys *
> (empty list or set)
> 127.0.0.1:6379> set a 1 xx
> (nil)
> 127.0.0.1:6379> get a
> (nil)
> 127.0.0.1:6379> set a 2
> OK
> 127.0.0.1:6379> set a 1 xx
> OK
> 127.0.0.1:6379> get a
> "1"

##### 1.6 set a 1 ex 10 nx 或者 set a 1 px 10000 nx

当key：a 不存在时添加一个定时的 value：1。

> 127.0.0.1:6379> keys *
> (empty list or set)
> 127.0.0.1:6379> set a 1 ex 10 nx
> OK
> 127.0.0.1:6379> get a
> "1"
> 10秒后
> 127.0.0.1:6379> get a
> (nil)

##### 1.7 set a 1 ex 10 xx 或者 set a 1 px 10000 xx

当key：a存在时才做修改

> 127.0.0.1:6379> keys *
> (empty list or set)
> 127.0.0.1:6379> set a 1 ex 10 xx
> (nil)
> 127.0.0.1:6379> get a
> (nil)
> 127.0.0.1:6379> set a 1
> OK
> 127.0.0.1:6379> set a 2 ex 10 xx
> OK
> 127.0.0.1:6379> get a
> "2"
> 127.0.0.1:6379> ttl a
> (integer) 6
> 127.0.0.1:6379> get a
> (nil)

##### 1.8 java代码（总结）

> ```java
> package com.learn.learn_redis;
> 
> import java.util.concurrent.TimeUnit;
> 
> import redis.clients.jedis.Jedis;
> import redis.clients.jedis.params.SetParams;
> 
> public class TestApi {
> 	public static void main(String[] args) throws InterruptedException {
> 		Jedis jedis = new Jedis("127.0.0.1", 6379);
> 		// 清空本地库
> 		jedis.flushDB();
> 		System.out.println("--------------1.1------------------");
> 
> 		// set a 1
> 		jedis.set("a", "1");
> 		System.out.println(jedis.get("a"));
> 		jedis.set("a", "2");
> 		System.out.println(jedis.get("a"));
> 
> 		jedis.flushDB();
> 		System.out.println("--------------1.2------------------");
> 
> 		// set a 1 ex 10 （ex 0会报错）
> 		jedis.set("a", "1", SetParams.setParams().ex(1));
> 		System.out.println(jedis.get("a"));
> 		TimeUnit.SECONDS.sleep(2);
> 		System.out.println(jedis.get("a"));
> 
> 		jedis.flushDB();
> 		System.out.println("--------------1.3------------------");
> 
> 		// set a 1 px 10 （px 0会报错）
> 		jedis.set("a", "1", SetParams.setParams().px(1000));
> 		System.out.println(jedis.get("a"));
> 		TimeUnit.SECONDS.sleep(2);
> 		System.out.println(jedis.get("a"));
> 		
> 		jedis.flushDB();
> 		System.out.println("--------------1.4------------------");
> 		
> 		// set a 1 nx（和xx相反）
> 		jedis.set("a", "1", SetParams.setParams().nx());
> 		System.out.println(jedis.get("a"));
> 		jedis.set("a", "2", SetParams.setParams().nx());
> 		System.out.println(jedis.get("a"));
> 		
> 		jedis.flushDB();
> 		System.out.println("--------------1.5------------------");
> 		
> 		// set a 1 xx （和nx相反）
> 		jedis.set("a", "1", SetParams.setParams().xx());
> 		System.out.println(jedis.get("a"));
> 		jedis.set("a", "1");
> 		System.out.println(jedis.get("a"));
> 		jedis.set("a", "2", SetParams.setParams().xx());
> 		System.out.println(jedis.get("a"));
> 
> 		jedis.flushDB();
> 		System.out.println("--------------1.6------------------");
> 		
> 		// set a 1 ex 10 nx 或者 set a 1 px 10000 nx
> 		jedis.set("a", "1", SetParams.setParams().ex(1).nx());
> 		System.out.println(jedis.get("a"));
> 		TimeUnit.SECONDS.sleep(2);
> 		System.out.println(jedis.get("a"));
> 		
> 		jedis.flushDB();
> 		System.out.println("--------------1.7------------------");
> 		
> 		// set a 1 ex 10 xx 或者 set a 1 px 10000 xx
> 		jedis.set("a", "2");
> 		System.out.println(jedis.get("a"));
> 		jedis.set("a", "1", SetParams.setParams().ex(1).xx());
> 		System.out.println(jedis.get("a"));
> 		TimeUnit.SECONDS.sleep(2);
> 		System.out.println(jedis.get("a"));
> 		
> 		jedis.close();
> 	}
> 
> }
> ```
>
> ```java
> // 和ex px有关设置成0，会抛出异常
> jedis.set("a", "1", SetParams.setParams().ex(0));
> 
> Exception in thread "main" redis.clients.jedis.exceptions.JedisDataException: ERR invalid expire time in set
> 	at redis.clients.jedis.Protocol.processError(Protocol.java:132)
> 	at redis.clients.jedis.Protocol.process(Protocol.java:166)
> 	at redis.clients.jedis.Protocol.read(Protocol.java:220)
> 	at redis.clients.jedis.Connection.readProtocolWithCheckingBroken(Connection.java:318)
> 	at redis.clients.jedis.Connection.getStatusCodeReply(Connection.java:236)
> 	at redis.clients.jedis.Jedis.set(Jedis.java:166)
> 	at com.learn.learn_redis.TestApi.main(TestApi.java:25)
> ```



#### 2. **GET key**

- 返回 `key` 所关联的字符串值。
- 如果 `key` 不存在那么返回特殊值 `nil` 。
- 假如 `key` 储存的值不是字符串类型，返回一个错误，因为 GET 只能用于处理字符串值。

> 127.0.0.1:6379> get a
> (nil)
> 127.0.0.1:6379> set a 1
> OK
> 127.0.0.1:6379> get a
> "1"
>
> 127.0.0.1:6379> LPUSH b 1 2 3
> (integer) 3
>
> 获取的key不是存储string类型的，则报错
>
> 127.0.0.1:6379> get b
> (error) WRONGTYPE Operation against a key holding the wrong kind of value
> 127.0.0.1:6379>       



#### 3. **SETEX key seconds value**（设置带过期秒数的key，设置0秒会报错）

- 将值 `value` 关联到 `key` ，并将 `key` 的生存时间设为 `seconds` (以秒为单位)。

- 如果 `key` 已经存在， `SETEX`命令将覆写旧值。

- 这个命令类似于以下两个命令：

  ```
  SET key value ex seconds
  EXPIRE key seconds
  ```
- 不同之处是， `SETEX` 是一个原子性(atomic)操作，关联值和设置生存时间两个动作会在同一时间内完成，该命令在 Redis 用作缓存时，非常实用。

> 127.0.0.1:6379> keys *
> (empty list or set)
> 127.0.0.1:6379> setex a 10 1
> OK
> 127.0.0.1:6379> get a
> "1"
> 10秒后
> 127.0.0.1:6379> get a
> (nil)
>
> 设置0秒也会报错
>
> 127.0.0.1:6379> setex a 0 1
> (error) ERR invalid expire time in setex



#### 4. **SETNX key value** （不存在才会设置value）

- 将 `key` 的值设为 `value` ，当且仅当 `key` 不存在。
- 若给定的 `key` 已经存在，则 `SETNX` 不做任何动作。
- `SETNX` 是『SET if Not eXists』(如果不存在，则 SET)的简写。

- 这个命令类似：

  ```
  set key value NX
  ```

> 127.0.0.1:6379> keys *
> (empty list or set)
> 127.0.0.1:6379> setnx a 1
> (integer) 1
> 127.0.0.1:6379> get a
> "1"
> 127.0.0.1:6379> setnx a 2
> (integer) 0
> 127.0.0.1:6379> get a
> "1"





#### 5. **SETBIT key offset value** （修改偏移量上的值）

在redis中，存储的字符串都是以二级制的进行存在的。

举例：

设置一个　key-value ，键的名字叫“a” 值为字符'a'

我们知道 'a' 的ASCII码是  97。转换为二进制是：01100001。offset的学名叫做“偏移” 。二进制中的每一位就是offset值啦，比如在这里  offset 0 等于 ‘0’ ，offset 1等于'1' ,offset2等于'1',offset 7 等于'1' ，没错，offset是从左往右计数的，也就是从高位往低位。



通过SETBIT 命令将 andy中的 'a' 变成 'b' 应该怎么变

也就是将 01100001 变成 01100010 （b的ASCII码是98），也就是将'a'中的offset 6从0变成1，将offset 7 从1变成0 。

每次SETBIT完毕之后，有一个（integer） 0或者（integer）1的返回值，这个是在你进行SETBIT 之前，该offset位的比特值。

> 127.0.0.1:6379> get a
> (nil)
> 127.0.0.1:6379> set a a
> OK
> 127.0.0.1:6379> SETBIT a 6 1
> (integer) 0
> 127.0.0.1:6379> SETBIT a 7 0
> (integer) 1
> 127.0.0.1:6379> get a
> "b"



#### 6. **GETBIT key offset **(获取偏移量的值)

- 对 `key` 所储存的字符串值，获取指定偏移量上的位(bit)。
- 当 `offset` 比字符串值的长度大，或者 `key` 不存在时，返回 `0` 

举例：

设置一个　key-value ，键的名字叫“a” 值为字符'a'

在 `5 SETBIT key offset value` 中知道了  'a' 的ASCII码是  97。转换为二进制是：01100001

> 127.0.0.1:6379> getbit a 6
> (integer) 0
> 127.0.0.1:6379> getbit a 7
> (integer) 1



#### 7. **SETRANGE key offset value** （设置字符串区间值）

- 用 `value` 参数覆写(overwrite)给定 `key` 所储存的字符串值，从偏移量 `offset` 开始。
- 不存在的 `key` 当作空白字符串处理。
- `SETRANGE` 命令会确保字符串足够长以便将 `value` 设置在指定的偏移量上，如果给定 `key` 原来储存的字符串长度比偏移量小(比如字符串只有 `5` 个字符长，但你设置的 `offset` 是 `10` )，那么原字符和偏移量之间的空白将用零字节(zerobytes, `"\x00"` )来填充。
- 注意你能使用的最大偏移量是 2^29-1(536870911) ，因为 Redis 字符串的大小被限制在 512 兆(megabytes)以内。如果你需要使用比这更大的空间，你可以使用多个 `key` 。

> 127.0.0.1:6379> set a 12345
> OK
>
> 从下标2开始 也就是 3 开始替换 34567
>
> 127.0.0.1:6379> SETRANGE a 2 34567
> (integer) 7
>
> 127.0.0.1:6379> get a
> "1234567"
>
> 127.0.0.1:6379> SETRANGE a 2 22
> (integer) 7
> 127.0.0.1:6379> get a
> "1222567"
>
> 如果offset不够用 \x00（占一位） 添加
>
> 127.0.0.1:6379> SETRANGE a 10 2
> (integer) 11
>
> 127.0.0.1:6379> get a
> "1222567\x00\x00\x002"
>
> 指定offset为负数则报错
>
> 127.0.0.1:6379> SETRANGE a -1 111
> (error) ERR offset is out of range



#### 8. **GETRANGE key start end **（获取字符串区间的值）

- 返回 `key` 中字符串值的子字符串，字符串的截取范围由 `start` 和 `end` 两个偏移量决定(包括 `start` 和 `end` 在内)。
- 负数偏移量表示从字符串最后开始计数， `-1` 表示最后一个字符， `-2` 表示倒数第二个，以此类推。
- `GETRANGE` 通过保证子字符串的值域(range)不超过实际字符串的值域来处理超出范围的值域请求。
- 这个方法很像java里的 String substring(int beginIndex, int endIndex) ，切割字符串



> 包括了 1 和 2
> 127.0.0.1:6379> set a 12345
> OK
> 127.0.0.1:6379> GETRANGE a 1 2
> "23"
>
> 如果范围 end 和 start区间有问题会返回 空字符串
> 127.0.0.1:6379> set a 12345
> OK
> 127.0.0.1:6379> GETRANGE a 2 1
> ""
> 127.0.0.1:6379> GETRANGE a 4 -2
> ""



#### 9. **GETSET key value** （设置并返回之前值）

- 将给定 `key` 的值设为 `value` ，并返回 `key` 的旧值(old value)。
- 当 `key` 存在但不是字符串类型时，返回一个错误。



> 127.0.0.1:6379> set a 1
> OK
> 127.0.0.1:6379> GETSET a 2
> "1"
> 127.0.0.1:6379> get a
> "2"
>
> 如果没有旧值，返回null
>
> 127.0.0.1:6379> getset b 1
> (nil)